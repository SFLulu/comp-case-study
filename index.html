<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compensation Case Study Allocator</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #ffffff; }
    .wrap { max-width: 1100px; margin: 0 auto; }

    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; background: #fff; }
    .big { font-size: 20px; font-weight: 700; }
    .muted { color: #666; font-size: 12px; }
    .tot { font-weight: 700; margin-top: 2px; }

    /* Pots */
    .pots { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; margin-bottom: 16px; }
    .potLabel { font-size: 14px; font-weight: 700; color: #444; margin-bottom: 4px; }

    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; vertical-align: top; }
    th { text-align: left; font-size: 12px; color: #444; }
    .rowTitle { font-weight: 700; margin-bottom: 2px; }

    /* Buttons */
    .btn { padding: 6px 10px; border: 1px solid #ccc; border-radius: 8px; background: #fff; cursor: pointer; font-size: 13px; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btns { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
    .footer { display: flex; align-items: center; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    .warn { color: #b00020; font-size: 12px; }

    /* Employee meta */
    .meta { margin-top: 4px; font-size: 12px; line-height: 1.3; }
    .meta .label { color: #666; }
    .meta .value { font-weight: 700; color: #000; }
    .meta .note { color: #666; font-style: italic; }

    /* Employee cards clickable after Finished */
    tbody tr.clickable { cursor: pointer; }
    tbody tr.clickable:hover { background: #fafafa; }
    tbody tr.selected { outline: 2px solid #cfcfcf; outline-offset: -2px; background: #f7f7f7; }

    /* Comparison panel */
    .compareWrap { margin-top: 12px; display: none; }
    .compareTitle { font-weight: 800; margin-bottom: 6px; }
    .compareGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .compareBox { border: 1px solid #eee; border-radius: 10px; padding: 10px; }
    .compareLabel { font-size: 12px; color: #666; margin-bottom: 2px; }
    .compareValue { font-weight: 800; }
    .compareDiff.good { color: #1b5e20; font-weight: 800; }
    .compareDiff.bad { color: #b00020; font-weight: 800; }

    /* Fatal error box if JS breaks */
    #fatalErrorBox { display:none; border: 2px solid #b00020; background: #fff5f5; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    #fatalErrorBox .title { font-weight: 800; color:#b00020; }
    #fatalErrorBox pre { white-space: pre-wrap; font-size: 12px; margin: 8px 0 0 0; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- Fatal error box (only shows if JS breaks) -->
  <div id="fatalErrorBox">
    <div class="title">Something broke in the allocator (JavaScript error)</div>
    <div class="muted">Copy the error text below and paste it back to troubleshoot.</div>
    <pre id="fatalErrorText"></pre>
  </div>

  <!-- INSTRUCTIONS (cleaned: removed crossed-out text; red text becomes black) -->
  <div class="card">
    <div class="big">Allocate funds to your team</div>
    <div class="muted">
      Use the +$500 / –$500 buttons to allocate merit and bonus funds to your employees. Totals update automatically.
      You do not need to use your entire merit or bonus budgets. Once you’re complete, click on the employee cards
      to compare your budget with the recommended answers.
    </div>
  </div>

  <!-- POTS -->
  <div class="pots">
    <div class="card">
      <div class="potLabel">Merit pot remaining</div>
      <div id="meritRemaining" class="big">$0</div>
      <div class="muted">Allocations must be in $500 increments.</div>
    </div>

    <div class="card">
      <div class="potLabel">Bonus pot remaining</div>
      <div id="bonusRemaining" class="big">$0</div>
      <div class="muted">Allocations must be in $500 increments.</div>
    </div>
  </div>

  <!-- Allocation Table -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th style="width:32%;">Employee</th>
          <th style="width:28%;">Context</th>
          <th style="width:20%;">Merit</th>
          <th style="width:20%;">Bonus</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="footer">
      <button class="btn" id="resetBtn">Reset allocations</button>
      <button class="btn" id="doneBtn" style="display:none;">Finished</button>
      <span class="warn" id="warning"></span>
    </div>

    <!-- Comparison panel appears after Finished and click on an employee -->
    <div class="compareWrap" id="compareWrap">
      <div class="compareTitle" id="compareTitle">Compare allocations</div>
      <div class="muted" style="margin-bottom:8px;">Your allocations vs. recommended answers for the selected employee.</div>

      <div class="compareGrid">
        <div class="compareBox">
          <div class="compareLabel">Your Merit</div>
          <div class="compareValue" id="yourMerit">$0</div>
          <div class="compareLabel" style="margin-top:8px;">Recommended Merit</div>
          <div class="compareValue" id="recMerit">$0</div>
          <div class="compareLabel" style="margin-top:8px;">Difference</div>
          <div id="diffMerit" class="compareDiff">$0</div>
        </div>

        <div class="compareBox">
          <div class="compareLabel">Your Bonus</div>
          <div class="compareValue" id="yourBonus">$0</div>
          <div class="compareLabel" style="margin-top:8px;">Recommended Bonus</div>
          <div class="compareValue" id="recBonus">$0</div>
          <div class="compareLabel" style="margin-top:8px;">Difference</div>
          <div id="diffBonus" class="compareDiff">$0</div>
        </div>
      </div>
    </div>

  </div>

</div>

<script>
(() => {
  "use strict";

  function showFatalError(err) {
    const box = document.getElementById("fatalErrorBox");
    const text = document.getElementById("fatalErrorText");
    if (box && text) {
      box.style.display = "block";
      text.textContent = String(err && err.stack ? err.stack : err);
    }
  }

  try {
    /* =========================
       CONFIGURATION
    ========================== */

    const DENOMINATION = 500;

    // Starting pots
    const START_MERIT = 13500;
    const START_BONUS = 32000;

    // Recommended answers (edit these when the Excel changes)
    const recommended = {
      Ines:   { merit: 0, bonus: 0 },
      Ananya: { merit: 0, bonus: 0 },
      Jace:   { merit: 0, bonus: 0 },
      Miles:  { merit: 0, bonus: 0 },
      Emilio: { merit: 0, bonus: 0 }
    };

    // Employee roster (Emilio may be $0; rule is enforced but not stated)
    const employees = [
      {
        empName: "Ines",
        title: "Business Analyst",
        basePay: 70000,
        performanceRating: "Exceptional",
        payRelative: "Competitive",
        notes: "Filled in for maternity leave",
        merit: 0,
        bonus: 0,
        canBeZero: false
      },
      {
        empName: "Ananya",
        title: "Sr Business Analyst",
        basePay: 80000,
        performanceRating: "Successful",
        payRelative: "Low",
        notes: "",
        merit: 0,
        bonus: 0,
        canBeZero: false
      },
      {
        empName: "Jace",
        title: "Sr Business Analyst",
        basePay: 85000,
        performanceRating: "Successful",
        payRelative: "Competitive",
        notes: "",
        merit: 0,
        bonus: 0,
        canBeZero: false
      },
      {
        empName: "Miles",
        title: "Business Manager",
        basePay: 130000,
        performanceRating: "Improve",
        payRelative: "Competitive",
        notes: "",
        merit: 0,
        bonus: 0,
        canBeZero: false
      },
      {
        empName: "Emilio",
        title: "Business Analyst",
        basePay: 80000,
        performanceRating: "Improve",
        payRelative: "High",
        notes: "",
        merit: 0,
        bonus: 0,
        canBeZero: true
      }
    ];

    /* =========================
       STATE
    ========================== */

    let meritRemaining = START_MERIT;
    let bonusRemaining = START_BONUS;

    // Completion state
    let markedDone = false;

    // Selected employee for compare
    let selectedEmpName = null;

    const fmt = (n) => n.toLocaleString("en-US", {
      style: "currency",
      currency: "USD",
      maximumFractionDigits: 0
    });

    const elMeritRemaining = document.getElementById("meritRemaining");
    const elBonusRemaining = document.getElementById("bonusRemaining");
    const elRows = document.getElementById("rows");
    const elWarning = document.getElementById("warning");
    const elResetBtn = document.getElementById("resetBtn");
    const elDoneBtn = document.getElementById("doneBtn");

    const elCompareWrap = document.getElementById("compareWrap");
    const elCompareTitle = document.getElementById("compareTitle");
    const elYourMerit = document.getElementById("yourMerit");
    const elRecMerit = document.getElementById("recMerit");
    const elDiffMerit = document.getElementById("diffMerit");
    const elYourBonus = document.getElementById("yourBonus");
    const elRecBonus = document.getElementById("recBonus");
    const elDiffBonus = document.getElementById("diffBonus");

    const required = [elMeritRemaining, elBonusRemaining, elRows, elWarning, elResetBtn, elDoneBtn,
                      elCompareWrap, elCompareTitle, elYourMerit, elRecMerit, elDiffMerit, elYourBonus, elRecBonus, elDiffBonus];

    if (required.some(x => !x)) {
      throw new Error("One or more required elements are missing from the page. (IDs changed or HTML not pasted fully.)");
    }

    function setWarning(msg) {
      elWarning.textContent = msg || "";
    }

    // Completion gate:
    // - Most employees must have >= $500 total across merit+bonus
    // - Emilio may be $0
    function hasAllocatedToEachEmployee() {
      return employees.every(e => {
        if (e.canBeZero) return true;
        return (e.merit + e.bonus) >= DENOMINATION;
      });
    }

    function updateComparison(empName) {
      const emp = employees.find(e => e.empName === empName);
      const rec = recommended[empName];
      if (!emp || !rec) return;

      elCompareWrap.style.display = "block";
      elCompareTitle.textContent = `Compare allocations: ${empName}`;

      elYourMerit.textContent = fmt(emp.merit);
      elYourBonus.textContent = fmt(emp.bonus);

      elRecMerit.textContent = fmt(rec.merit);
      elRecBonus.textContent = fmt(rec.bonus);

      const dM = emp.merit - rec.merit;
      const dB = emp.bonus - rec.bonus;

      const fmtDiff = (d) => {
        const sign = d > 0 ? "+" : "";
        return `${sign}${fmt(d)}`.replace("$-", "-$");
      };

      elDiffMerit.textContent = fmtDiff(dM);
      elDiffBonus.textContent = fmtDiff(dB);

      elDiffMerit.classList.remove("good","bad");
      elDiffBonus.classList.remove("good","bad");
      elDiffMerit.classList.add(dM === 0 ? "good" : "bad");
      elDiffBonus.classList.add(dB === 0 ? "good" : "bad");
    }

    function render() {
      elMeritRemaining.textContent = fmt(meritRemaining);
      elBonusRemaining.textContent = fmt(bonusRemaining);

      const readyForDone = hasAllocatedToEachEmployee();

      // Show Finished only when gate satisfied OR already marked done
      elDoneBtn.style.display = (readyForDone || markedDone) ? "inline-block" : "none";
      elDoneBtn.disabled = markedDone;
      elDoneBtn.textContent = markedDone ? "Finished ✓" : "Finished";

      // Build table rows
      elRows.innerHTML = "";

      employees.forEach((e, idx) => {
        const tr = document.createElement("tr");
        tr.dataset.emp = e.empName;

        if (markedDone) tr.classList.add("clickable");
        if (selectedEmpName === e.empName) tr.classList.add("selected");

        // Employee column
        const tdEmp = document.createElement("td");
        tdEmp.innerHTML = `
          <div class="rowTitle">${e.empName}</div>
          <div class="muted">${e.title}</div>
          <div class="meta">
            <span class="label">Performance Rating:</span> <span class="value">${e.performanceRating}</span>
          </div>
        `;
        tr.appendChild(tdEmp);

        // Context column
        const tdCtx = document.createElement("td");
        tdCtx.innerHTML = `
          <div class="muted">Base pay</div>
          <div class="tot">${fmt(e.basePay)}</div>
          <div class="meta" style="margin-top:6px;">
            <span class="label">Pay Relative to Others:</span> <span class="value">${e.payRelative}</span>
            ${e.notes ? `<div class="note" style="margin-top:4px;">${e.notes}</div>` : ""}
          </div>
        `;
        tr.appendChild(tdCtx);

        // Merit column
        const tdMerit = document.createElement("td");
        tdMerit.innerHTML = `
          <div class="muted">Allocated</div>
          <div class="tot">${fmt(e.merit)}</div>
          <div class="btns">
            <button class="btn" ${markedDone || meritRemaining < DENOMINATION ? "disabled" : ""} data-action="meritPlus" data-idx="${idx}">+ $500</button>
            <button class="btn" ${markedDone || e.merit < DENOMINATION ? "disabled" : ""} data-action="meritMinus" data-idx="${idx}">– $500</button>
          </div>
        `;
        tr.appendChild(tdMerit);

        // Bonus column
        const tdBonus = document.createElement("td");
        tdBonus.innerHTML = `
          <div class="muted">Allocated</div>
          <div class="tot">${fmt(e.bonus)}</div>
          <div class="btns">
            <button class="btn" ${markedDone || bonusRemaining < DENOMINATION ? "disabled" : ""} data-action="bonusPlus" data-idx="${idx}">+ $500</button>
            <button class="btn" ${markedDone || e.bonus < DENOMINATION ? "disabled" : ""} data-action="bonusMinus" data-idx="${idx}">– $500</button>
          </div>
        `;
        tr.appendChild(tdBonus);

        elRows.appendChild(tr);
      });
    }

    function adjust(idx, type, delta) {
      setWarning("");

      if (markedDone) {
        return setWarning("You marked this as finished. Click Reset allocations to make changes.");
      }

      if (type === "merit") {
        if (delta > 0 && meritRemaining < DENOMINATION) return setWarning("Merit pot is empty.");
        if (delta < 0 && employees[idx].merit < DENOMINATION) return;
        employees[idx].merit += delta;
        meritRemaining -= delta;
      }

      if (type === "bonus") {
        if (delta > 0 && bonusRemaining < DENOMINATION) return setWarning("Bonus pot is empty.");
        if (delta < 0 && employees[idx].bonus < DENOMINATION) return;
        employees[idx].bonus += delta;
        bonusRemaining -= delta;
      }

      render();
    }

    // +/– button clicks
    document.addEventListener("click", (ev) => {
      const btn = ev.target.closest("button[data-action]");
      if (!btn) return;

      const idx = Number(btn.dataset.idx);
      const action = btn.dataset.action;

      if (action === "meritPlus")  adjust(idx, "merit",  DENOMINATION);
      if (action === "meritMinus") adjust(idx, "merit", -DENOMINATION);
      if (action === "bonusPlus")  adjust(idx, "bonus",  DENOMINATION);
      if (action === "bonusMinus") adjust(idx, "bonus", -DENOMINATION);
    });

    // Employee card click AFTER Finished
    elRows.addEventListener("click", (ev) => {
      const row = ev.target.closest("tr");
      if (!row) return;

      const empName = row.dataset.emp;
      if (!empName) return;

      if (!markedDone) return; // no-op before finished

      selectedEmpName = empName;
      render();
      updateComparison(empName);
    });

    // Finished button
    elDoneBtn.addEventListener("click", () => {
      if (!hasAllocatedToEachEmployee()) {
        setWarning("Allocate funds to each employee before clicking “Finished”.");
        return;
      }
      markedDone = true;
      setWarning("Click an employee card to compare your budget with the recommended answers.");
      selectedEmpName = null;
      elCompareWrap.style.display = "none";
      render();
    });

    // Reset
    elResetBtn.addEventListener("click", () => {
      employees.forEach(e => { e.merit = 0; e.bonus = 0; });
      meritRemaining = START_MERIT;
      bonusRemaining = START_BONUS;
      markedDone = false;
      selectedEmpName = null;
      elCompareWrap.style.display = "none";
      setWarning("");
      render();
    });

    render();

  } catch (err) {
    showFatalError(err);
  }
})();
</script>

</body>
</html>
